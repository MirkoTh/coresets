<!DOCTYPE html>
<html>

<head>
    <script src="jspsych-dist/dist/jspsych.js"></script>
    <script src="jspsych-dist/dist/plugin-html-button-response.js"></script>
    <script src="jspsych-dist/dist/plugin-html-keyboard-response.js"></script>
    <script src="jspsych-dist/dist/plugin-image-keyboard-response.js"></script>
    <script src="jspsych-dist/dist/plugin-preload.js"></script>
    <script src="jspsych-dist/dist/plugin-survey-text.js"></script>
    <script src="jspsych-dist/plugins/jspsych-instructions.js"></script>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <script src="js-helpers.js"></script>
    <script src="jspsych-psychophysics.js"></script>
    <link rel="stylesheet" href="jspsych-dist/dist/jspsych.css">
    <link rel="stylesheet" href="my-style.css">
    <style>
        .jspsych-display-element {
            font-size: 40px;
        }
    </style>
    </link>
</head>


<body></body>
<script>


    // still to do
    // save data on server
    // create fixed stimulus set and load it


    // This file demonstrates how to present multiple images in random order in succession.
    // That is, Rapid serial visual presentation (RSVP) 

    const jsPsych = initJsPsych({
        on_finish: function () {
            jsPsych.data.displayData();
        }
    })
    console.log(`jsPsych Version ${jsPsych.version()}`)

    const pixi_flag = jsPsych.data.getURLVariable('pixi_flag') === '1' ? true : false;

    randomize = true // present different set sizes in random order. if false, set sizes will be presented in ascending order
    file_name = null // file name for data file. if null, a default name consisting of the participant ID and a unique number is chosen.
    local = true // save the data file locally.
    // If this test is being run online (e.g., on MTurk), true will cause the file to be downloaded to the participant's computer.
    // If this test is on a server, and you wish to save the data file to that server, change this to false.
    // If changed to false, ensure that the php file (its in the directory!) and the empty "data" folder has also been appropriately uploaded to the server.
    // Incase of problems, feel free to contact me :)

    //----------------------------------------------------------------------



    if (window.location.search.indexOf('PROLIFIC_PID') > -1) {
        var participant_id = getQueryVariable('PROLIFIC_PID');
    }
    // If no ID is present, generate one using random numbers - this is useful for testing
    else {
        var participant_id = Math.floor(Math.random() * 1000);
    }
    // STUDY ID
    if (window.location.search.indexOf('STUDY_ID') > -1) {
        var studyID = getQueryVariable('STUDY_ID');
    }

    console.log("current participant_id = " + participant_id);


    // what we need
    // category learning train
    //// stimuli nrs 1:150 to train
    //// stimuli 50% category 1, 50% category 2
    //// 
    // recognition 
    //// stimuli 50% initially presented (all), 50% new
    // category learning generalization
    //// only 150 new items: 1:150 to test

    // to start, just use 2D monsters from rep change project


    var n_categories = 2;
    var n_trials_train = 150;
    var n_trials_recog = n_trials_train * 2;
    var n_trials_generalize = n_trials_train;

    const x1_max = 100;
    const x2_max = 100;
    var id0 = [];
    var id1 = []; // diagonal is excluded in information-integration structure
    var cat0 = [];
    var cat1 = [];
    var x = [];
    var y = [];

    counter = 0;
    for (var i = 1; i <= x1_max; i++) {
        for (var j = 1; j <= x2_max; j++) {
            x[counter] = i;
            y[counter] = j;
            if (i > j) {
                id0.push(counter);
                cat0.push(0);
                counter += 1;
            } else if (i < j) {
                id1.push(counter);
                cat1.push(1);
                counter += 1;
            }
        }
    }
    // generate random sequence of stimuli in both categories
    const prep0 = Array(id0.length).fill().map((element, index) => index);
    const prep1 = Array(id1.length).fill().map((element, index) => index);
    const which_ids_0 = jsPsych.randomization.sampleWithoutReplacement(prep0, n_trials_recog / 2 + n_trials_generalize / 2);
    const which_ids_1 = jsPsych.randomization.sampleWithoutReplacement(prep1, n_trials_recog / 2 + n_trials_generalize / 2);


    stimuli = make_stimuli(n_trials_train, n_trials_recog, n_trials_generalize, which_ids_0, which_ids_1);

    console.log("stimuli[ids_train].length = " + stimuli["ids_train"].length);
    console.log("stimuli[ids_train] = " + stimuli["ids_train"]);
    console.log("stimuli[cat_train] = " + stimuli["cat_train"]);

    // randomize train, recog, and generalize stimuli and cat ids
    both_train = shuffle_ids_and_cats(stimuli["ids_train"], stimuli["cat_train"]);
    both_lures = shuffle_ids_and_cats(stimuli["ids_lures"], stimuli["cat_lures"]);
    both_generalize = shuffle_ids_and_cats(stimuli["ids_generalize"], stimuli["cat_generalize"]);

    console.log("ids_lures = " + both_lures["ids"]);
    console.log("cat_lures = " + both_lures["cat"]);


    var n_recalled;
    var n_recalled_correctly;


    var instructions1 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;"><b>INSTRUCTIONS</b><br><br>This is the updating task. <br>This task has two parts: <br>(1) Memorization of the initially presented digits <br>(2) Individually updating selected digits <br><br><br><br><br><br><br><br><br><br><br></div>',
        choices: ["Next"]
    };
    var instructions2 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;">In every trial, four digits colored in different colors are presented on the screen. Remember these four digits in the correct order.<br>There will be a series of seven updating steps.<br>At every updating step, one digit is replaced by a different digit.<br>Occasionally, it may be replaced by the same digit already presented previously at that location. <br> In the end of the trial, you are required to recall the last four digits at every location.<br> Please note that the ordering of the digits is important. A recalled digit is only going to be counted as correct if it is recalled in the correct location.<br><br><br><br><br><br><br><br><br><br><br></div>',
        choices: ["Next"]
    };
    var instructions3 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;">Recall the digits using the number pad on your keyboard.<br>For example, if the last four digits were 9, 3, 6, 9, please respond "9369".<br><br><br>If you are unsure what has been presented most recently at one or several locations, please guess in these locations.<br><br><br><br><br><br><br><br><br><br><br><br><br></div>',
        choices: ["Next"]
    };
    var instructions4 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;">Occasionally, you have to recall the initial set of digits immediately. Again, please recall in the correct order. You get two practice trials to get used to the two versions of the task (immediate recall and recall after the updating steps).<br><br><br><br><br><br><br><br><br><br><br> </div>',
        choices: ["Start Practice"]
    };
    var instructions_test = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;">These were the two practice trials.<br>The main part of the updating task is going to start now.<br>Good luck.<br><br><br><br><br><br><br><br><br> </div>',
        choices: ["Start Main Part"]
    };


    var train_stimuli = [];
    for (let i = 0; i < 5; i++) { //n_trials_train
        stim_path = {
            stimulus: "stimuli/stimulus[" + x[both_train["ids"][i]] + "," + y[both_train["ids"][i]] + "].png",
            correct_response: ['f', 'j'][both_train["cat"][i]]

        };
        train_stimuli.push(stim_path);
    }

    var fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: "NO_KEYS",
        trial_duration: 1000,
    };

    var judge_category = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['f', 'j'],
        data: {
            task: "categorization - train",
            correct_response: jsPsych.timelineVariable("correct_response")
        },
        on_finish: function (data) {
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
        }
    }

    var feedback = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function (data) {
            var is_correct = jsPsych.data.get().last(1).values()[0].correct;
            console.log("is_correct = " + is_correct);
            if (is_correct == true) {
                return ('<div style="font-size:60px;color:green">Correct!</div>')
            } else if (is_correct == false) {
                return ('<div style="font-size:60px;color:red">Wrong!</div>')
            }
        },
        choices: "NO_KEYS",
        trial_duration: 1000,
    };

    var train_procedure = {
        timeline: [fixation, judge_category, feedback],
        timeline_variables: train_stimuli
    }


    timeline = [];
    timeline.push(train_procedure);

    /* start the experiment */
    jsPsych.run(timeline);

</script>

</html>